#!/usr/bin/env bash
set -euo pipefail
# agent-tmux - run any command in tmux for phone access
#
# Usage: agent-tmux <command> [args...]
# Example: alias claude='agent-tmux claude'

if [ $# -eq 0 ]; then
    echo "Usage: agent-tmux <command> [args...]"
    exit 1
fi

CMD="$1"
shift

# Word lists for random names (little familiars)
ADJECTIVES=(clever sleepy happy busy cozy gentle curious eager nimble quick)
NOUNS=(otter panda fox rabbit owl mouse seal frog duck wren)

# Generate unique session name (retry on collision)
PROJECT=$(basename "$PWD")
for _ in {1..10}; do
    ADJ=${ADJECTIVES[$RANDOM % ${#ADJECTIVES[@]}]}
    NOUN=${NOUNS[$RANDOM % ${#NOUNS[@]}]}
    SESSION="${CMD}-${PROJECT}-${ADJ}-${NOUN}"

    if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        break
    fi
done

# Final check - if still colliding, append PID
if tmux has-session -t "$SESSION" 2>/dev/null; then
    SESSION="${SESSION}-$$"
fi

echo "Starting $CMD in tmux session: $SESSION"
echo "Access from phone via agent-phone picker"

# Create new tmux session with the command
# Store working directory in tmux environment for agent-phone to read
tmux new-session -d -s "$SESSION" -c "$PWD" -- "$CMD" "$@"
tmux set-environment -t "$SESSION" AGENT_TMUX_DIR "$PWD"
tmux set-environment -t "$SESSION" AGENT_TMUX_CMD "$CMD"
exec tmux attach -t "$SESSION"
